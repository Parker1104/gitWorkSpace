<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<%@ page language="java" pageEncoding="utf-8"%>
<%@ page contentType="text/html;charset=UTF-8" %>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
    <link rel="stylesheet" href="${pageContext.request.contextPath}/assets/bootstrap/css/bootstrap.min.css">
    <script src="${pageContext.request.contextPath}/js/jquery/jQuery-2.2.0.min.js"></script>
    <script src="${pageContext.request.contextPath}/js/bootstrap/js/bootstrap.min.js"></script>
	<title>开箱测试</title>
</head>
<style>
body{
  	background-color:#F0F0F0;
}
.text{
	margin:1%;
	margin-left:0px;
}

.button{
	margin:5%;
}

.top{
	background-color: #F2F2F2;
	margin-top:70px;
	border:1px solid #373a3c;
	border-radius:15px;
	margin-left:5%;
	margin-right:5%;
	padding:5%;
}
.u-topper{
    height: 42px;
    background-color: #373a3c;
    color: #999999;
    text-align:center;
}
.u-topper p {
    display: -webkit-box;
    display: flex;
    -webkit-box-pack: center;
    justify-content: center;
    -webkit-box-align: center;
    align-items: center;
    -webkit-box-flex: 1;
    flex: 1;
    height: 40px;
    color: #cfcfcf;
    font-size: 22px;

}
.u-footer{
	
    background-color: #373a3c;
    color: #999999;
    text-align:center;
}
.container,body,html {
    height: 100%;
}
.container {
    position: relative;
    background-color: #3e3e40;
    overflow: hidden
}
.u-content {
    -webkit-box-flex: 1;
    flex: 1;
    position: relative;
    overflow: hidden;
    background-image: -webkit-gradient(linear,0 0,0 100%,from(#f88427),to(#fb5811));
}
.u-footer {
    height: 40px;
    background-color: #373a3c;
    display: -webkit-box;
    display: flex;
    -webkit-box-align: center;
    align-items: center;
    position:absolute;
    bottom:0;
    right:0;
    left:0;
}
.u-footer p.active {
    color: #999999;
}
.u-footer p {
    display: -webkit-box;
    display: flex;
    -webkit-box-pack: center;
    justify-content: center;
    -webkit-box-align: center;
    align-items: center;
    -webkit-box-flex: 1;
    flex: 1;
    color: #cfcfcf;
    font-size: 14px;
}

</style>
<body >
		<div id="top" class="u-topper">
			<p lang="header">开 箱 测 试</p>
		</div>
		<%-- <div id="ajax-loader"
			style="display:none;cursor: progress; position: fixed; top: -50%; left: -50%; width: 200%; height: 200%; background: #fff; z-index: 10000; overflow: hidden;">
			<img src="${pageContext.request.contextPath}/img/ajax-loader.gif"
				style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; margin: auto;" />
		</div> --%>
		<div class=top style="">
				设备编号：<input id =terminalid class=text type="text" style="width:200px;font-family: '微软雅黑';text-align:center;"/>
				</br>
				开箱方式：<select id="select">
					  <option value="1">加密</option>
					  <option value="2">无加密</option>
					</select>
				</br>
				循环次数：<input id =cout class=text type="text" style="width:50px;text-align:center;"
				onkeyup="(this.v=function(){this.value=this.value.replace(/[^0-9-]+/,'');}).call(this)" />
				</br>
				起始箱号：<input id =startbox class=text type="text" style="width:50px;text-align:center;"
				onkeyup="(this.v=function(){this.value=this.value.replace(/[^0-9-]+/,'');}).call(this)" />
				</br>
				结束箱号：<input id =endbox class=text type="text" style="width:50px;text-align:center;"
				onkeyup="(this.v=function(){this.value=this.value.replace(/[^0-9-]+/,'');}).call(this)" />
				</br>
			
		</div>
		<div style="text-align: center;margin-top:50px;">
			<button class="btn btn-primary btn-lg" style="border-radius: 25px;"
	            data-toggle="modal" data-target="#myModal" onclick="action()">开 始
	    	</button>
		</div>
			
		<div id="foot"class="u-footer">
			<p class="active" >杭州东城电子有限责任公司</p> 
	    </div>
      	<!-- 模态框（Modal） -->
  <div class="modal fade" id="myModal"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
            &times;
          </button>
          <h4 class="modal-title" id="myModalLabel">
            反馈信息
          </h4>
        </div>
        <div id="returnmsg" class="modal-body">
          <!-- <progress max="100" value="0" id="pg" style="display: none"></progress> -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
          <button id="action" onclick="openBox()" style="display: none"> action </button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal -->
  </div>




  <script type="text/javascript">
      /* var pg=document.getElementById('pg');
      setInterval(function(){
          if(pg.value!=100) pg.value++;
          else pg.value=0;
      },100); */

    function openBox(){
        var terminalid = $("#terminalid").val();
        var cout = $("#cout").val();
        var startbox = $("#startbox").val();
        var key = $("#select").val();
        var endbox = $("#endbox").val();
        endbox++;
        var result = checkInfo(terminalid,cout,startbox,endbox);
        if(result==0){
            for(var h=0;h<cout;h++){
                if(startbox>endbox){
                	$("#myModal").css({"margin-top":"100px"});
                    $("#returnmsg").append("起始箱号不得大于结束箱号！");
                }else{
                	$("#myModal").css({"margin-top":"0px"});
                    for(var j=startbox;j<endbox;j++){
                        console.log("box:"+j);
                        sentMsg(terminalid,j,key);
                    }
                }
            }
        }else{
        	$("#myModal").css({"margin-top":"100px"});
            $("#returnmsg").append(result);
        }
    }



    /*参数检验*/
    function checkInfo(terminalid,cout,startbox,endbox){
        var result;
        if(terminalid.length==0||cout.length==0||startbox.length==0||endbox.length==0){
            result = "参数不能为空，请输入参数";
        }
        else if(terminalid.length!=24){
            console.log(terminalid.length);
            result = "设备号不合法，请重新输入24位设备号";
        } 
        else if(startbox>endbox){
            result = "起始箱号不得大于结束箱号！";
        } else{
            result = 0;
        }
        return result;
    }

    function sentMsg(terminalid,boxno,key) {

        $.ajax({
            type: "POST",
            dataType:"json",
            async:false,
            url: "${pageContext.request.contextPath}/openBoxTest/loopOpenBox",
            data:{"terminalid":terminalid,"boxno":boxno,"key":key},
            contentType: 'application/x-www-form-urlencoded',
            success: function(res){
                console.log(res.returnMsg);
                var jsonstr = JSON.stringify(res.returnMsg);
                console.log(res.returnMsg.err_msg);
                if(res.returnMsg.err_msg=="ok"){
                	$("#returnmsg").append("<p style='text-align:center'>"+"---------------"+boxno+"号箱开箱成功---------------"+"<p/>");
	                $("#returnmsg").append("<p>"+"反馈信息："+jsonstr+"<p/>");
	                $("#returnmsg").append("<p>"+"请求时间："+res.startTime+"<p/>");
	                $("#returnmsg").append("<p>"+"接受时间："+res.overTime+"<p/>");
	                $("#returnmsg").append("<p>"+"时间间隔："+res.timedif+"秒"+"<p/>");
                }else{
	                $("#returnmsg").append("<p style='color:red;text-align:center'>"+"!!!!!!!!!!!!!!!"+boxno+"号箱开箱失败!!!!!!!!!!!!!!!"+"<p/>");
	                $("#returnmsg").append("<p style='color:red;'>"+"错误信息："+jsonstr+"<p/>");
	                $("#returnmsg").append("<p>"+"请求时间："+res.startTime+"<p/>");
	                $("#returnmsg").append("<p>"+"接受时间："+res.overTime+"<p/>");
	                $("#returnmsg").append("<p>"+"时间间隔："+res.timedif+"秒"+"<p/>");
                }
            }
        });
    }
    function action(){
        $("#returnmsg").empty();
        a();
    }
	function a(){
		openBox();
	}


  </script>
</body>
</html>




















